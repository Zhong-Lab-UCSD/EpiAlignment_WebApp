<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EpiAlignment - Result</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet" type="text/css">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@1.3.15/dist/vuetify.min.css" rel="stylesheet" type="text/css">
  <link href="styles/mainstyles.css" rel="stylesheet" type="text/css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-78231712-3"></script>
  <script src="js/googleAnalytics.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/vue@2.5.21/dist/vue.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/vuetify@1.3.15/dist/vuetify.min.js"></script>
  <script defer src="js/lib/moment.min.js"></script>
  <script defer src="js/lib/moment-timezone-with-data.min.js"></script>
  <script defer src="js/result.js" type="module"></script>
</head>

<body>
  <div id="header" class="result noFlex flexRow flexCenter flexWrap">
    <div id="headerContainer" class="flex flexColumn flexStretch flexNoWrap flexNoGap">
      <h1 class="flex"><a href="index.html">EpiAlignment</a></h1>
    </div>
    <div id="headerButtonHolder" class="flex flexRow flexWrap flexCenter justifyEnd">
      <a class="buttons flexRow flexCenter justifyCenter" target="_blank" href="manual.html"><i class="material-icons">help_outline</i>Manual</a>
      <a class="buttons flexRow flexCenter justifyCenter" title="A template python program that can be used to access EpiAlignment"
        target="_blank" href="assets/PythonClient.zip"><i class="material-icons">save_alt</i>Python
        client template</a>
    </div>
  </div>
  <div data-app id="result_app" class="flex flexColumn flexStretch" v-cloak>
    <div id="runInfo" class="noFlex">
      <div v-show="!showRunDetails" class="collapsedRunInfo noFlex flexRow flexCenter flexWrap flexNoGap justifyStart">
        <div class="noFlex flexRow flexWrap flexNoGap justifyStart" v-for="row in collapsedRunInfoList">
          <div class="flexRow flexWrap noFlex flexStart flexNoGap" :class="{ parameter: entry.parameter }" v-for="entry in row">
            <span class="entryKey" v-html="entry.key"></span>
            <span class="entryValue">{{ entry.value }}</span>
          </div>
        </div>
        <div class="runInfoShowHide selfAlignStart" @click="showRunInfoDetails">Show more details ...</div>
      </div>
      <div v-show="showRunDetails" class="expandedRunInfo noFlex flexColumn flexNoWrap flexNoGap">
        <div class="noFlex flexRow flexWrap flexNoGap justifyStart" v-for="row in expandedRunInfoList">
          <div class="flexRow flexWrap noFlex flexStart flexNoGap" :class="{ parameter: entry.parameter }" v-for="entry in row">
            <span class="entryKey" v-html="entry.key"></span>
            <span class="entryValue">{{ entry.value }}</span>
          </div>
        </div>
        <div class="runInfoShowHide selfAlignStart" @click="foldRunInfoDetails">Fold details</div>
      </div>
    </div>
    <div class="errorContainer" v-if="error">
      <p>Error encountered when calculating your results. Please check your inputs
        and try again.</p>
      <p> If you have any questions, please use the "Contact us via
        email" link at the bottom of the page to report the problems, or report
        the issue via Github from the "Find us on Github" link. Please include
        your Run ID (shown above) when reporting an error.
      </p>
      <p>Error message:
        <code>{{ errorMessage }}</code>
      </p>
    </div>
    <div class="errorContainer warning" v-if="showWarning && !error">
      <div class="tooltipPanel flexColumn">
        <div class="flexRow flexWrap flexNoGap">
          <div class="flex">The following warning(s) occured during
            the alignment run:</div>
          <div class="closeError noFlex" v-show="loading">
            <em>You may hide the warning(s) once the job is done.</em>
          </div>
          <div class="closeError noFlex" v-show="!loading">
            <i class="material-icons button" @click="closeWarning()">close</i>
          </div>
        </div>
        <code>{{ errorMessage }}</code>
      </div>
    </div>
    <div class="loadingHolder flexColumn flexStretch" v-show="loading">
      <h3>Calculating...</h3>
      <img class="selfAlignStart" src="assets/images/loading.gif">
      <div>
        Please wait: your data is still being computed.
        <strong>
          This page will automatically refresh every {{ pollingTime / 1000 }} seconds.
        </strong>
      </div>
      <div :class=" { highlightBlink: highlightLoading } ">
        Last refreshed at: 
        <strong>
          {{ lastRefreshedTime }}
        </strong>
      </div>
      <div>
        You may bookmark this page now and check back later. To
        bookmark this page, please press <span class="keyboard">Ctrl</span> +
        <span class="keyboard">D</span> (on a PC) or
        <span class="keyboard">⌘ Command</span> +
        <span class="keyboard">D</span>
        (on a Mac) and follow the instructions of your web browser (if any).
        Once the results are available, you may fetch your results via the
        bookmarked page in <strong>14 days</strong>.
      </div>
      <div v-show="alignMode === 'enhancer' && !email">
        Due to the many processing steps and larger search regions
        involved, enhancer mode may take minutes to run. Therefore,
        <strong>bookmarking this page is highly recommended</strong>.
      </div>
      <div v-show="email">
        You will also receive an email at your email address at
        {{ email }} once the computation is done. <strong>Note: </strong>
        please check your spam folder regularly, or make sure
        messenger@mail.givengine.org is on
        your approved sender list ("white list") and/or in your address book.
      </div>
    </div>
    <div id="pageContainer" class="flexRow flexStart flexWrap flexNoGap" v-if="!loading && !error">
      <div id="heatmapPanel" class="flexRow flexStart flex flexWrap" v-if="alignMode === 'promoter'">
        <div id="heatmap">
          <div class="flexColumn flexStart">
            <div class="selfAlignStretch resultHeader">EpiAlign Score</div>
            <table>
              <thead>
                <tr>
                  <th class="placeholder"></th>
                  <th class="heatmapColLabels" v-for="entry in promoterColumnList">
                    <div>
                      {{ entry }}
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="rowEntry in epiHeatmapList">
                  <th>{{ rowEntry.geneId }}</th>
                  <td class="heatmapCell" v-for="value in rowEntry.values">
                    <div class="heatmapObj">
                      <div class="heatmapBorder" :class="{ seqMax: value.seqMax && rowEntry.labelMax, epiMax: value.epiMax && rowEntry.labelMax, insignificant: value.insignificant }">
                      </div>
                      <div class="heatmapValueCell" :style="{ opacity: (Number.isNaN(parseFloat(value.epiScoreNorm)) ? 1 : value.epiScoreNorm) }">
                      </div>
                      <div class="overlay flexRow flexNoWrap flexCenter justifyCenter" v-show="value.epiMax">H</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div v-if="hasSequence" class="selfAlignStretch resultHeader">Sequence-only Score</div>
            <table v-if="hasSequence">
              <thead>
                <tr>
                  <th class="placeholder"></th>
                  <th class="heatmapColLabels" v-for="entry in promoterColumnList">
                    <div>{{ entry }}</div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="rowEntry in epiHeatmapList">
                  <th>{{ rowEntry.geneId }}</th>
                  <td class="heatmapCell" v-for="value in rowEntry.values">
                    <div class="heatmapObj">
                      <div class="heatmapBorder" :class="{ seqMax: value.seqMax && rowEntry.labelMax, epiMax: value.epiMax && rowEntry.labelMax, insignificant: value.insignificant }">
                      </div>
                      <div class="heatmapValueCell" :style="{ opacity:  (Number.isNaN(parseFloat(value.seqScoreNorm)) ? 1 : value.seqScoreNorm) }">
                      </div>
                      <div class="overlay flexRow flexNoWrap flexCenter justifyCenter" v-show="value.seqMax">H</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div id="heatmapLegend" class="selfAlignStretch flexColumn flexStretch flexNoGap flexNoWrap">
              <!-- Scale bar -->
              <div class="flexRow flexCenter flexNoWrap">
                <div class="flexRow flexEnd flexNoGap noFlex" id="colorScaleGroup">
                  {{ Number.parseFloat(heatmapDesc.min).toFixed(2) }}
                  <div id="colorScaleContainer">
                    <!-- 95th percentile indicator -->
                    <div id="percentile95" v-if="heatmapDesc.showPercentile" :style="{ 'margin-left': (heatmapDesc.percentileValue - heatmapDesc.min) / heatmapDesc.span * 100 + '%' }">
                      <span>{{ Number.parseFloat(heatmapDesc.percentileValue).toFixed(2) }}</span>
                    </div>
                    <div id="colorScale"></div>
                  </div>
                  {{ Number.parseFloat(heatmapDesc.max).toFixed(2) }}
                </div>
                <div class="flex">Alignment score</div>
              </div>
              <!-- H sign -->
              <div class="flexRow flexStart flexNoWrap">
                <div class="flexRow flexCenter noFlex flexNoGap flexNoWrap" :class="{ withPercentile: percentileEnabled }">
                  <div class="legendIcon heatmapObj noFlex plain">
                    <div class="overlay flexRow flexNoWrap flexCenter justifyCenter">H</div>
                  </div>
                </div>
                <div class="flex">Target with highest score</div>
              </div>
              <!-- Seq-best pair -->
              <div v-if="hasSequence" class="flexRow flexStart flexNoWrap">
                <div class="flexRow flexCenter noFlex flexNoGap flexNoWrap" :class="{ withPercentile: percentileEnabled }">
                  <div class="legendIcon heatmapBorder epiMax noFlex"></div>
                  <div v-if="percentileEnabled" class="legendIcon heatmapBorder epiMax noFlex insignificant"></div>
                </div>
                <div class="flex">Shifted EpiAlign target</div>
              </div>
              <div v-if="hasSequence" class="flexRow flexStart flexNoWrap">
                <div class="flexRow flexCenter noFlex flexNoGap flexNoWrap" :class="{ withPercentile: percentileEnabled }">
                  <div class="legendIcon heatmapBorder seqMax noFlex"></div>
                  <div v-if="percentileEnabled" class="legendIcon heatmapBorder seqMax noFlex insignificant"></div>
                </div>
                <div class="flex">Original sequence-only alignment target</div>
              </div>
            </div>
          </div>
        </div>
        <div id="heatmapDesc" class="flex">
          <div class="resultHeader">Result description</div>
          <p>
            EpiAlignment score are plotted in the heatmap to show scores of
            all given target region(s) (column) against any query region (row).
          </p>
          <p>
            A sequence-only alignment result is also provided for comparative
            purposes. This result should be similar to a sequence alignment
            algorithm.
          </p>
          <p>
            EpiAlignment can detects if the best it for any query region (row)
            switches from one target region to another with EpiAlign and
            Sequence-only alignment. For any query region, if:
            <ul>
              <li>
                the best hit region with EpiAlign (<em>the new hit</em>) is
                different from the best hit region with Sequence-only (<em>the
                  old hit</em>), and
              </li>
              <li>
                <em>the new hit</em> has a <em>higher</em> score with
                EpiAlign than with Sequence-only alignment, and
              </li>
              <li>
                <em>the old hit</em> has a <em>lower</em> score with
                EpiAlign than with Sequence-only alignment,
              </li>
            </ul>
            <em>the new hit</em> will be marked on the heatmap with a green
            square ( <div class="legendIcon heatmapBorder epiMax"></div> ), and
            <em>the old hit</em> will be marked with a gray square (
            <div class="legendIcon heatmapBorder seqMax"></div>
            ).
            <span v-if="percentileEnabled">
              If <em>the new hit</em> has a lower Sequence-only score than the
              95th percentile of random sequences (marked on the color scale bar
              if it's not the maximum), the border of the square for both
              <em>the new hit</em> and <em>the old hit</em> will be dashed (
              <div class="legendIcon heatmapBorder epiMax insignificant"></div>
              and <div class="legendIcon heatmapBorder seqMax insignificant"></div>
              ).
            </span>
          </p>
          <p>
            <em>
              (Note: if you set epigenomic weight to zero during input,
              the EpiAlignment score will be the degenerated sequence-only
              alignment score, and no sequence-only result will be reported.)
            </em>
          </p>
        </div>
      </div>
      <div class="resultHolder flexColumn flexStretch flex flexNoGap">
        <div class="resultHeader flexRow flexWrap flexCenter flexNoGap">
          <span>Result data table</span>
          <a class="buttonLink" :href="downloadLink" download="results.txt" target="_blank"><i class="material-icons">
              save_alt
            </i>
            Download results</a>
        </div>
        <div class="enhancerHint tooltipPanel flexRow flexNoGap flexWrap justifyEnd" v-if="showResultHint">
          <div class="hintContent flex">You may click on the
            <div class="btnWithAnno"><i class="material-icons">open_in_new</i>
              <div class="annotation">GIVE</div>
            </div> icon at the beginning of each row to show a side-by-side
            view of the query and the target region in a browser powered by
            GIVE, or click on the
            <div class="btnWithAnno"><i class="material-icons">open_in_new</i><div class="annotation">UCSC</div></div>
            icon after each coordinate to open the region in UCSC Genome Browser.
            <span v-if="alignMode === 'enhancer'">
              You may also click on individual table rows to see detailed results.
            </span>
          </div>
          <div class="closeHint nobr noFlex flexRow flexCenter flexNoGap">
            <input type="checkbox" v-model="doNotShowHintAgain" id="doNotShow">
            <label for="doNotShow">Do not show this again</label>
            <i class="material-icons button" @click="closeHint()">close</i>
          </div>
        </div>
        <v-data-table :headers="headers" :items="dataEntries" item-key="index" class="elevation-1" :pagination.sync="paginationObj"
          :rows-per-page-items="rowsPerPageItems" sort-icon="keyboard_arrow_up">
          <template slot="no-data">
          </template>
          <template slot="items" slot-scope="row">
            <tr @click="toggleRow(row)" :class=" { expandable: alignMode === 'enhancer' } ">
              <td class="dataTableCell">{{ row.item.index }}</td>
              <td class="dataTableCell dataTableCellNoGap"><a @click.stop class="noFlex btnWithAnno" target="_blank" title="Open region in GIVE Browser"
                :href="getGiveLink([queryGenomeAssembly, targetGenomeAssembly], [row.item.region1, row.item.region2])"><i class="material-icons">
                  open_in_new
                </i><div class="annotation">GIVE</div>
              </a></td>
              <td class="dataTableCell">{{ row.item[geneIdentifier1] }}</td>
              <td class="dataTableCell" v-if="row.item.ensID1 !== '.'">{{ row.item.ensID1 }}</td>
              <td class="dataTableCell">
                {{ row.item.region1 }} <a @click.stop class="noFlex btnWithAnno" target="_blank" title="Open region in UCSC Genome Browser"
                  :href="getUcscLink(queryGenomeAssembly, row.item.region1)"><i class="material-icons">
                    open_in_new
                  </i><div class="annotation">UCSC</div></a>
              </td>
              <td class="dataTableCell" v-if="row.item[geneIdentifier2] !== '.'">{{ row.item[geneIdentifier2] }}</td>
              <td class="dataTableCell" v-if="row.item.ensID2 !== '.'">{{ row.item.ensID2 }}</td>
              <td class="dataTableCell">
                {{ row.item.region2 }} <a @click.stop class="noFlex btnWithAnno" target="_blank" title="Open region in UCSC Genome Browser"
                  :href="getUcscLink(targetGenomeAssembly, row.item.region2)"><i class="material-icons">
                    open_in_new
                  </i><div class="annotation">UCSC</div></a>
              </td>
              <td class="dataTableCell" :class="{'text-xs-right': alignMode === 'promoter'}">{{ alignMode ===
                'promoter' ?
                Number.parseFloat(row.item.scoreE).toFixed(3) : row.item.targetE }}</td>
              <td class="dataTableCell" :class="{'text-xs-right': alignMode === 'promoter'}">
                {{ alignMode === 'promoter' ? (row.item.scoreS !== '.'
                  ? Number.parseFloat(row.item.scoreS).toFixed(3) : '---')
                : row.item.targetS !== '.' ? row.item.targetS : '---' }}</td>
            </tr>
          </template>
          <template slot="expand" slot-scope="entry">
            <v-card flat>
              <div class="flexRow flexStretch enhancerCardContainer">
                <div class="resultImgHolder flexColumn flexCenter flexNoWrap flexNoGap noFlex justifyCenter">
                  <img v-show="entry.item.image" :src="entry.item.image">
                </div>
                <div class="flex resultDesc">
                  <div class="resultHeader">Result description</div>
                  <p>
                    The alignment score along the entire target region is
                    plotted in the figure to the left. The hit regions are the
                    locations with the highest alignment score.
                  </p>
                  <p>
                    A sequence-only alignment result is provided below
                    ("SeqOnly") for comparative purposes.
                  </p>
                  <p>
                    The EpiAlignment scores for the hit region is shown below:
                  </p>
                  <div class="enhancerScoreContainer flexColumn flexNoWrap flexNoGap">
                    <div class="flexRow flexNoWrap">
                      <div>EpiAlign:</div>
                      <div>{{ Number.parseFloat(entry.item.scoreE).toFixed(3) }}</div>
                    </div>
                    <div v-show="entry.item.targetS !== '.'" class="flexRow flexNoWrap">
                      <div>Sequence-only:</div>
                      <div>{{ Number.parseFloat(entry.item.scoreS).toFixed(3) }}</div>
                    </div>
                  </div>
                  <p>
                    <em>
                      (Note: if you set epigenomic weight to zero during
                      input, the EpiAlignment score will be the degenerated
                      sequence-only alignment score, and no sequence-only
                      result will be reported.)
                    </em>
                  </p>
                </div>
              </div>
            </v-card>
          </template>
        </v-data-table>
        <div id="embeddedBrowser"></div>
      </div>
    </div>
  </div>
  <div id="footer" class="flexRow flexWrap flexCenter noFlex justifyEnd">
    <div class="flex flexColumn flexStretch flexNoGap">
      <!-- footer text -->
      <div>Copyright © 2018 The Regents of the University of California. All Rights
        Reserved.</div>
      <div class="flex flexRow flexWrap flexStretch flexNoGap">
        <div>Created by Jia Lu, Xiaoyi Cao and Sheng Zhong, Department of
          Bioengineering.</div>
        <a href='&#109;&#097;&#105;&#108;&#116;&#111;:&#115;&#122;&#104;&#111;&#110;&#103;&#064;&#101;&#110;&#103;&#046;&#117;&#099;&#115;&#100;&#046;&#101;&#100;&#117;'>Contact
          us via email</a>
        <a href="https://github.com/Zhong-Lab-UCSD/EpiAlignment_WebApp" target="_blank">Find us on Github</a>
      </div>
    </div>
    <img id="ucsdLogo" src="assets/images/UCSanDiegoLogo-White.png">
  </div>
</body>

</html>